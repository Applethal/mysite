---
title: "Mathematically get the worst lower number of turns needed to finish a turn-based RPG fight"
date: 2024-07-27

tags: ["Optimization","Operational research","Mathematics"]
Summary: "Is this how speedrunners plan their routes ? Post's picture taken from xkcd's 1445th comic"
draft: false

---

<style>
    .scrollable-div {
        overflow-x: auto;

        white-space: nowrap;

    }
</style>

<p> I love turn based RPG games, especially those where I have no control over the mobility of my characters, as these
    reduce the problem size of my decisions, making me
    only decide on actions and ignore positioning. Other than that I get to enjoy the privilege of taking all the time I need in
    order to make a decision. </p>

<p>Weeks ago I was playing the original <a href="https://de.wikipedia.org/wiki/Final_Fantasy_VII">Final Fantasy VII</a>
    for the first time in my life, and I somehow lost my patience
    against a group of monsters. Wanting to breeze
    through the game, I started to heuristically tinker ways in order to minimize the number of turns that it takes to
    end my fights as quick as I can. I had to account
    for my mana resource, especially since Final Fantasy VII's options in that regard were very costly back when I
    reached
    that chapter.</p>

<p>I wondered how speedrunners come up with the all those strategies that allow them to reach the high skies of the
    leaderboards; There is indeed potential for some Operational research! And that is what sparked the following idea:
    We can use linear programming to determine:</p>

<ul>
    <li>The upper bound of the number of turns that it takes to finish a fight
    <li>Which attacks to use
</ul>

<p>What I will be presenting here, sadly, does not work for every game out there, <s> it specifically works only for the
    aforementioned type of games with no
    press turn gimmicks (Sorry Shin Megami Tensei fans)</s>. The model assumes that every member will move at the same turn,
    so games with Active Time Battle, which is true
    for the original Final Fantasy 7 if you disable it. It is sadly an upper bound because these games usually come with
    RNG mechanics that may either be a hindrance, like evasion stats, or a blessing, like with critical hits. Other
    than that, the output of an attack may appear to be an integer, but in most games, the output stems from a ceiling
    function that considers many shenanigans, hence why some people may mention that their attacks could not reach a
    range.</p>

<h3>The model </h3>

<p>Small disclaimer: This model will only work if you assume the following:
<ul>
    <li>You have enough mana to finish the fight</li>
    <li>Your attacks can happen with no restrictions (e.i. Cooldowns..etc..)</li>



</ul>




</p>


<p>With that out of the way, Let's discuss the input data. To model this, I need the following sets:</p>



<ul>
    <li>\(c \in C\): Set of characters
    <li>\(e \in E\): Set of enemies
    <li>\(a,o \in A\): Set of attacks with \([a_1, a_2...a_n]\) \(\cap \) \([o_1,o_2....o_3]\). \(a\) are the single
        target
        attacks, and \(o\) represent the attacks that can hit multiple enemies.
</ul>

<p>As for the parameters, the model requires:</p>

<ul>
    <li>\(m_a\): The Mana/Stamina parameter of each attack \(a\)
    <li>\(HP_e\): The HP of each enemy \(e\)
    <li>\(p^c_{ae}\): The power coefficient of each attack \(a\) that the character \(c\) can apply to enemy \(e\)
</ul>

<p>The power of an attack is computed after considering the attack parameter of the character and adding up the enemy's
    weakness factor. This varies of course from game to game, consult the game's manual on how the power parameters are
    computed, some games have this information public while some don't offer it and could use some years of reverse
    engineering. </p>

<p>With that out of the way, let's discuss how this is going to work. I decided to use a 3 index formulation, let
    \(X_{ca}^{e}\) be the variable that determines the number of attacks \(a\) a character \(c\) is using on an enemy
    \(e\), attacks that target multiple enemies will have a variable that contains only 2 indices, the attack \(a\) and
    the character \(c\)</p>


<p> Finally, the following objective function aims to minimize the number of attack actions, since all characters move
    at the same turn. The output of the objective function will then be divided by the number of ally units that you
    control and that's how you get the upper bound of the turns needed to finish the fight. This objective function
    implicitly minimizes the number of turns if you think about it. With that out of the way, behold: </p>
<div class="scrollable-div">
    \[min Z = \sum\limits_{a \in A}{} \sum\limits_{c\in C}{} \sum\limits_{e\in E}{} + X^c_{ae} \sum\limits_{o \in A}
    \sum\limits_{c\in C}{} {X^c_{o}}\]
    \[\sum\limits_{a \in A}{X^c_{ae} \cdot p^c_{ae} } + \sum\limits_{a \in A}{X^c_{o} \cdot p^c_{oe} \geq HP_e} \quad
    \forall e
    \in E \]
    \[
    \sum\limits_{a \in A} X^c_{ae} \cdot m_{a} + \sum\limits_{o \in A} X^c_{o} \cdot m_{o} \leq M_c \quad \forall c \in
    C
    \]

    \[X^c_{ae}, X^c_{o} \geq 0\]
</div>


<p>The objective function aims to minimize the number of attacks. The first constraint ensures that the chosen attacks
    will be sufficient to eliminate the enemies, while the second constraint allows the model to choose the attacks that
    can't outcredit the mana of each character. </p>


<p>However, if you are playing <a href="https://en.wikipedia.org/wiki/The_Legend_of_Dragoon">Legend of Dragoon</a>
    (Great game by the way), this model works only in scenarios where you
    use a single character, since the game has an agility parameter that breaks linearity of turns.
    And for that, you might need an extra constraint for the item spells; since these have no mana costs but have
    limited usage
    depending on how many of them your inventory contains, which ensures that the item spells \(i\) used
    does not exceed their amounts, of course you might want to add the variable \(X^c_{i}\) to the first 2 constraints'
    left
    hand side and express its positivity in the last constraint of course. You can, if you want, get rid of the \(c\)
    index
    since you are using only character but that won't change the size of the problem.</p>

\[X^c_{i} \leq amount_i \quad \forall i \in I\]


<p>As for the Shin Megami combat Tensei system, the number of turns can be estimated by exploiting the press system's rewarding
gimmick, which gives an extra turn for every critical hit/elemental piercing attacks. Assuming of course that you have enough
mana for all the spells, then the amount of turns necessary to end the fight is :</p>

\[
\text{Turns} = \left\lceil \frac{Z- \text{spells that cause weakness hits}}{|C|} \right\rceil
\]




<h2>Closing words </h2>

<p>As much as I enjoyed the making of this model, it's not perfect, and as mentioned before, it does not suit every game
    design. I Was thinking about adding more gimmicks considering damage over time (e.i. <a
        href="https://bulbapedia.bulbagarden.net/wiki/Toxic_(move)"></a>Pokemon's toxic), but these had
    me consider using the big M constant, which would render my formulation weak if the wrong big M parameter is chosen.
    I might update this in the future. <s>Even though I mentioned that this would not work for the Megaten games with their
    press turn system, the output should give you an idea about how long the fight could go</s>. Accounting for stat boosts
    mid-fights will turn it into a non-linear model, still, it does serve the job; I will passively see if there are any
    improvements that I can do to account for those special cases. </p>
